{% extends "user/layouts/base.html" %}

{% block title %}Dashboard - ClimaChat{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}
{% block page_title %}Weather Dashboard{% endblock %}
{% block page_subtitle %}Stay informed about current weather conditions{% endblock %}

{% block content %}
<!-- Weather Alerts Section -->
{% include 'user/components/alerts/weather_alerts.html' %}

<!-- Weather Overview Cards -->
{% include 'user/components/weather/weather_overview.html' %}

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main Weather Info -->
    <div class="lg:col-span-3">
        {% include 'user/components/weather/detailed_weather.html' %}

        <!-- Health & Safety Tips -->
        {% include 'user/components/health/health_tips.html' %}
    </div>

    <!-- Sidebar Content -->
    <div class="lg:col-span-1">
        <!-- Quick Chat Access -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 text-white mb-6">
            <h3 class="text-lg font-semibold mb-2">Ask ClimaChat</h3>
            <p class="text-blue-100 text-sm mb-4">Get instant weather information and personalized advice.</p>
            <a href="{% url 'user_chat' %}" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span class="text-sm font-medium">Start Chat</span>
            </a>
        </div>

        <!-- Weather Map Preview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Weather Map</h3>
                <a href="{% url 'weather_map' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    View Full Map
                </a>
            </div>
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative">
                <div id="dashboard-map" class="w-full h-full"></div>
                <div id="dashboard-map-loading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                        <p class="text-xs text-gray-500">Loading map...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Dashboard mini map
let dashboardMap;
let userLocation = null;
let weatherData = null;
// OPENWEATHER_API_KEY is already declared in base.html

// Get user's current location and fetch weather data
async function getUserLocationAndWeather() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                userLocation = { lat, lon };

                // Fetch weather data
                await fetchWeatherData(lat, lon);

                // Update map center
                if (dashboardMap) {
                    dashboardMap.setView([lat, lon], 10);
                    L.marker([lat, lon]).addTo(dashboardMap)
                        .bindPopup(`<b>Your Location</b><br>${weatherData?.location || 'Current Location'}`)
                        .openPopup();
                }
            },
            function(error) {
                console.error('Geolocation error:', error.message);
                // Fallback to default location (Manila, Philippines)
                fetchWeatherData(14.5995, 120.9842);
            }
        );
    } else {
        console.log('Geolocation not supported');
        // Fallback to default location
        fetchWeatherData(14.5995, 120.9842);
    }
}

// Fetch weather data from OpenWeather API
async function fetchWeatherData(lat, lon) {
    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}`);
        const data = await response.json();

        if (data && data.main) {
            weatherData = {
                location: `${data.name}, ${data.sys.country}`,
                temperature: Math.round(data.main.temp),
                feels_like: Math.round(data.main.feels_like),
                condition: data.weather[0].description,
                condition_main: data.weather[0].main,
                humidity: data.main.humidity,
                wind_speed: Math.round(data.wind.speed * 3.6), // Convert m/s to km/h
                wind_deg: data.wind.deg,
                pressure: data.main.pressure,
                visibility: (data.visibility / 1000).toFixed(1), // Convert m to km
                sunrise: new Date(data.dt * 1000 + data.timezone * 1000).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'UTC'
                }),
                sunset: new Date((data.sys.sunset * 1000) + (data.timezone * 1000)).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'UTC'
                }),
                coordinates: { lat: data.coord.lat, lon: data.coord.lon }
            };

            // Fetch air quality data
            await fetchAirQualityData(lat, lon);

            // Update dashboard UI
            updateDashboardUI(weatherData);

            // Fetch AI-generated health tips
            await fetchHealthTips(weatherData);
        }
    } catch (error) {
        console.error('Error fetching weather:', error);
    }
}

// Fetch air quality data from OpenWeather API
async function fetchAirQualityData(lat, lon) {
    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`);
        const data = await response.json();

        if (data && data.list && data.list.length > 0) {
            const airQuality = data.list[0];
            const aqi = airQuality.main.aqi; // Air Quality Index (1-5)
            const components = airQuality.components;

            // Add air quality data to weatherData
            weatherData.air_quality = aqi;
            weatherData.air_quality_status = getAirQualityStatus(aqi);
            weatherData.air_quality_components = components;

            console.log('Air quality data:', {aqi, status: weatherData.air_quality_status, components});
        }
    } catch (error) {
        console.error('Error fetching air quality:', error);
        // Set default values if air quality fetch fails
        weatherData.air_quality = '--';
        weatherData.air_quality_status = 'Unavailable';
    }
}

// Fetch AI-generated health tips
async function fetchHealthTips(weatherData) {
    console.log('Fetching AI health tips with data:', weatherData);

    try {
        const requestData = {
            temperature: weatherData.temperature,
            feels_like: weatherData.feels_like,
            condition: weatherData.condition,
            humidity: weatherData.humidity,
            wind_speed: weatherData.wind_speed,
            air_quality: weatherData.air_quality || 1
        };

        console.log('Sending health tips request:', requestData);

        const response = await fetch('/api/health-tips/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        });

        console.log('Health tips response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Health tips response data:', data);

            if (data.success && data.tips && data.tips.length > 0) {
                console.log('Displaying', data.tips.length, 'AI-generated tips');
                displayHealthTips(data.tips);
            } else {
                console.warn('No tips received from API');
            }
        } else {
            const errorText = await response.text();
            console.error('Health tips API error:', response.status, errorText);
        }
    } catch (error) {
        console.error('Error fetching health tips:', error);
    }
}

// Display health tips in the UI
function displayHealthTips(tips) {
    const healthTipsContainer = document.querySelector('.health-tips-container');
    if (!healthTipsContainer) return;

    const categoryIcons = {
        'temperature': `<svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        'humidity': `<svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" clip-rule="evenodd"></path></svg>`,
        'uv': `<svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>`,
        'air': `<svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
        'general': `<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`
    };

    const categoryColors = {
        'temperature': 'bg-red-100',
        'humidity': 'bg-blue-100',
        'uv': 'bg-yellow-100',
        'air': 'bg-purple-100',
        'general': 'bg-green-100'
    };

    const tipsHTML = tips.map(tip => {
        const icon = categoryIcons[tip.category] || categoryIcons['general'];
        const bgColor = categoryColors[tip.category] || categoryColors['general'];

        return `
            <div class="p-3 border border-gray-100 rounded-lg hover:shadow-sm transition-shadow">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 ${bgColor} rounded-lg flex items-center justify-center">
                            ${icon}
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-medium text-gray-900 mb-1">${tip.title}</h3>
                        <p class="text-sm text-gray-600">${tip.description}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    healthTipsContainer.innerHTML = tipsHTML;
    console.log('Health tips updated:', tips);
}

// Get CSRF token for POST requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update dashboard UI with weather data
function updateDashboardUI(data) {
    // Update location
    const locationElements = document.querySelectorAll('[data-weather="location"]');
    locationElements.forEach(el => el.textContent = data.location);

    // Update temperature
    const tempElement = document.querySelector('[data-weather="temperature"]');
    if (tempElement) tempElement.textContent = data.temperature;

    const feelsLikeElement = document.querySelector('[data-weather="feels-like"]');
    if (feelsLikeElement) feelsLikeElement.textContent = data.feels_like;

    // Update humidity
    const humidityElement = document.querySelector('[data-weather="humidity"]');
    if (humidityElement) humidityElement.textContent = data.humidity;

    const humidityStatusElement = document.querySelector('[data-weather="humidity-status"]');
    if (humidityStatusElement) {
        humidityStatusElement.textContent = getHumidityStatus(data.humidity);
    }

    // Update wind speed
    const windSpeedElement = document.querySelector('[data-weather="wind-speed"]');
    if (windSpeedElement) windSpeedElement.textContent = data.wind_speed;

    const windDirectionElement = document.querySelector('[data-weather="wind-direction"]');
    if (windDirectionElement) {
        windDirectionElement.textContent = getWindDirection(data.wind_deg);
    }

    // Update pressure
    const pressureElement = document.querySelector('[data-weather="pressure"]');
    if (pressureElement) pressureElement.textContent = data.pressure;

    const pressureStatusElement = document.querySelector('[data-weather="pressure-status"]');
    if (pressureStatusElement) {
        pressureStatusElement.textContent = getPressureStatus(data.pressure);
    }

    // Update visibility
    const visibilityElement = document.querySelector('[data-weather="visibility"]');
    if (visibilityElement) visibilityElement.textContent = data.visibility;

    const visibilityStatusElement = document.querySelector('[data-weather="visibility-status"]');
    if (visibilityStatusElement) {
        visibilityStatusElement.textContent = getVisibilityStatus(data.visibility);
    }

    // Update sunrise/sunset
    const sunriseElement = document.querySelector('[data-weather="sunrise"]');
    if (sunriseElement) sunriseElement.textContent = data.sunrise;

    const sunsetElement = document.querySelector('[data-weather="sunset"]');
    if (sunsetElement) sunsetElement.textContent = data.sunset;

    // Update condition
    const conditionElement = document.querySelector('[data-weather="condition"]');
    if (conditionElement) {
        conditionElement.textContent = data.condition.charAt(0).toUpperCase() + data.condition.slice(1);
    }

    // Update air quality
    const airQualityElement = document.querySelector('[data-weather="air-quality"]');
    if (airQualityElement && data.air_quality) {
        airQualityElement.textContent = data.air_quality;
    }

    const airQualityStatusElement = document.querySelector('[data-weather="air-quality-status"]');
    if (airQualityStatusElement && data.air_quality_status) {
        airQualityStatusElement.textContent = data.air_quality_status;
    }

    console.log('Dashboard updated with real weather data:', data);
}

// Helper functions
function getHumidityStatus(humidity) {
    if (humidity < 30) return 'Low';
    if (humidity < 60) return 'Normal';
    if (humidity < 80) return 'High';
    return 'Very High';
}

function getWindDirection(deg) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const index = Math.round(deg / 45) % 8;
    return directions[index];
}

function getPressureStatus(pressure) {
    if (pressure < 1000) return 'Low';
    if (pressure < 1020) return 'Normal';
    return 'High';
}

function getVisibilityStatus(visibility) {
    if (visibility < 2) return 'Poor';
    if (visibility < 10) return 'Moderate';
    return 'Good';
}

function getAirQualityStatus(aqi) {
    // Air Quality Index from OpenWeather API (1-5 scale)
    // 1 = Good, 2 = Fair, 3 = Moderate, 4 = Poor, 5 = Very Poor
    switch(aqi) {
        case 1: return 'Good';
        case 2: return 'Fair';
        case 3: return 'Moderate';
        case 4: return 'Poor';
        case 5: return 'Very Poor';
        default: return 'Unknown';
    }
}

function initDashboardMap() {
    dashboardMap = L.map('dashboard-map', {
        zoomControl: false,
        scrollWheelZoom: false,
        dragging: false,
        touchZoom: false,
        doubleClickZoom: false
    }).setView([14.5995, 120.9842], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(dashboardMap);

    // Hide loading indicator
    document.getElementById('dashboard-map-loading').style.display = 'none';

    // Make map clickable to go to full map
    dashboardMap.on('click', function() {
        window.location.href = "{% url 'weather_map' %}";
    });
}

// Auto-refresh weather data every 5 minutes
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dashboard map
    if (document.getElementById('dashboard-map')) {
        initDashboardMap();
    }

    // Get user location and weather data
    getUserLocationAndWeather();

    // Auto-refresh every 5 minutes
    setInterval(() => {
        console.log('Refreshing weather data...');
        if (userLocation) {
            fetchWeatherData(userLocation.lat, userLocation.lon);
        } else {
            getUserLocationAndWeather();
        }
    }, 300000); // 5 minutes

    // Add click handlers for alert dismissal
    document.querySelectorAll('[data-dismiss-alert]').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.border-l-4').style.display = 'none';
        });
    });
});
</script>

<!-- User Location Tracker -->
{% load static %}
<script src="{% static 'js/map/user_location.js' %}"></script>
{% endblock %}