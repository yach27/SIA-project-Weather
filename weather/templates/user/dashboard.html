{% extends "user/layouts/base.html" %}

{% block title %}Dashboard - ClimaChat{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}
{% block page_title %}Weather Dashboard{% endblock %}
{% block page_subtitle %}Stay informed about current weather conditions{% endblock %}

{% block content %}
<!-- Weather Alerts Section -->
{% include 'user/components/alerts/weather_alerts.html' %}

<!-- Weather Overview Cards -->
{% include 'user/components/weather/weather_overview.html' %}

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main Weather Info -->
    <div class="lg:col-span-3">
        {% include 'user/components/weather/detailed_weather.html' %}

        <!-- Health & Safety Tips -->
        {% include 'user/components/health/health_tips.html' %}
    </div>

    <!-- Sidebar Content -->
    <div class="lg:col-span-1">
        <!-- Quick Chat Access -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl p-6 text-white mb-6">
            <h3 class="text-lg font-semibold mb-2">Ask ClimaChat</h3>
            <p class="text-blue-100 text-sm mb-4">Get instant weather information and personalized advice.</p>
            <a href="{% url 'user_chat' %}" class="inline-flex items-center px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition-all duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span class="text-sm font-medium">Start Chat</span>
            </a>
        </div>

        <!-- Weather Map Preview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Weather Map</h3>
                <a href="{% url 'weather_map' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                    View Full Map
                </a>
            </div>
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden relative">
                <div id="dashboard-map" class="w-full h-full"></div>
                <div id="dashboard-map-loading" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-2"></div>
                        <p class="text-xs text-gray-500">Loading map...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const DEFAULT_LOCATION = { lat: 14.5995, lon: 120.9842 }; // Manila, Philippines
let dashboardMap;
let userLocation = null;
let weatherData = null;

// Get user's current location and fetch weather data
async function getUserLocationAndWeather() {
    if (!navigator.geolocation) {
        fetchWeatherData(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon);
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (position) => {
            userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };

            await fetchWeatherData(userLocation.lat, userLocation.lon);

            if (dashboardMap) {
                dashboardMap.setView([userLocation.lat, userLocation.lon], 10);
                L.marker([userLocation.lat, userLocation.lon])
                    .addTo(dashboardMap)
                    .bindPopup(`<b>Your Location</b><br>${weatherData?.location || 'Current Location'}`)
                    .openPopup();
            }
        },
        () => fetchWeatherData(DEFAULT_LOCATION.lat, DEFAULT_LOCATION.lon)
    );
}

// Fetch weather data from OpenWeather API
async function fetchWeatherData(lat, lon) {
    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}`);
        const data = await response.json();

        if (data?.main) {
            weatherData = {
                location: `${data.name}, ${data.sys.country}`,
                temperature: Math.round(data.main.temp),
                feels_like: Math.round(data.main.feels_like),
                condition: data.weather[0].description,
                condition_main: data.weather[0].main,
                humidity: data.main.humidity,
                wind_speed: Math.round(data.wind.speed * 3.6),
                wind_deg: data.wind.deg,
                pressure: data.main.pressure,
                visibility: (data.visibility / 1000).toFixed(1),
                coordinates: { lat: data.coord.lat, lon: data.coord.lon }
            };

            await fetchAirQualityData(lat, lon);
            updateDashboardUI(weatherData);
            await fetchHealthTips(weatherData);
        }
    } catch (error) {
        console.error('Error fetching weather:', error);
    }
}

// Fetch air quality data from OpenWeather API
async function fetchAirQualityData(lat, lon) {
    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`);
        const data = await response.json();

        if (data?.list?.[0]) {
            const aqi = data.list[0].main.aqi;
            weatherData.air_quality = aqi;
            weatherData.air_quality_status = getAirQualityStatus(aqi);
            weatherData.air_quality_components = data.list[0].components;
        }
    } catch (error) {
        weatherData.air_quality = '--';
        weatherData.air_quality_status = 'Unavailable';
    }
}

// Fetch AI-generated health tips
async function fetchHealthTips(weatherData) {
    try {
        const response = await fetch('/api/health-tips/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                temperature: weatherData.temperature,
                feels_like: weatherData.feels_like,
                condition: weatherData.condition,
                humidity: weatherData.humidity,
                wind_speed: weatherData.wind_speed,
                air_quality: weatherData.air_quality || 1
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success && data.tips?.length > 0) {
                displayHealthTips(data.tips);
            }
        }
    } catch (error) {
        console.error('Error fetching health tips:', error);
    }
}

// Display health tips in the UI
function displayHealthTips(tips) {
    const healthTipsContainer = document.querySelector('.health-tips-container');
    if (!healthTipsContainer) return;

    const categoryIcons = {
        'temperature': `<svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        'humidity': `<svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z" clip-rule="evenodd"></path></svg>`,
        'uv': `<svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>`,
        'air': `<svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
        'general': `<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`
    };

    const categoryColors = {
        'temperature': 'bg-red-100',
        'humidity': 'bg-blue-100',
        'uv': 'bg-yellow-100',
        'air': 'bg-purple-100',
        'general': 'bg-green-100'
    };

    const tipsHTML = tips.map(tip => {
        const icon = categoryIcons[tip.category] || categoryIcons['general'];
        const bgColor = categoryColors[tip.category] || categoryColors['general'];

        return `
            <div class="p-3 border border-gray-100 rounded-lg hover:shadow-sm transition-shadow">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 ${bgColor} rounded-lg flex items-center justify-center">
                            ${icon}
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-medium text-gray-900 mb-1">${tip.title}</h3>
                        <p class="text-sm text-gray-600">${tip.description}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    healthTipsContainer.innerHTML = tipsHTML;
}

// Get CSRF token for POST requests
function getCookie(name) {
    if (!document.cookie) return null;

    const cookie = document.cookie.split(';').find(c => c.trim().startsWith(name + '='));
    return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
}

// Update dashboard UI with weather data
function updateDashboardUI(data) {
    const updates = {
        'location': data.location,
        'temperature': data.temperature,
        'feels-like': data.feels_like,
        'humidity': data.humidity,
        'humidity-status': getHumidityStatus(data.humidity),
        'wind-speed': data.wind_speed,
        'wind-direction': getWindDirection(data.wind_deg),
        'pressure': data.pressure,
        'pressure-status': getPressureStatus(data.pressure),
        'visibility': data.visibility,
        'visibility-status': getVisibilityStatus(data.visibility),
        'condition': data.condition.charAt(0).toUpperCase() + data.condition.slice(1),
        'air-quality': data.air_quality,
        'air-quality-status': data.air_quality_status
    };

    Object.entries(updates).forEach(([key, value]) => {
        if (value === undefined) return;
        const elements = document.querySelectorAll(`[data-weather="${key}"]`);
        elements.forEach(el => el.textContent = value);
    });
}

// Helper functions
function getHumidityStatus(humidity) {
    if (humidity < 30) return 'Low';
    if (humidity < 60) return 'Normal';
    if (humidity < 80) return 'High';
    return 'Very High';
}

function getWindDirection(deg) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const index = Math.round(deg / 45) % 8;
    return directions[index];
}

function getPressureStatus(pressure) {
    if (pressure < 1000) return 'Low';
    if (pressure < 1020) return 'Normal';
    return 'High';
}

function getVisibilityStatus(visibility) {
    if (visibility < 2) return 'Poor';
    if (visibility < 10) return 'Moderate';
    return 'Good';
}

function getAirQualityStatus(aqi) {
    // Air Quality Index from OpenWeather API (1-5 scale)
    // 1 = Good, 2 = Fair, 3 = Moderate, 4 = Poor, 5 = Very Poor
    switch(aqi) {
        case 1: return 'Good';
        case 2: return 'Fair';
        case 3: return 'Moderate';
        case 4: return 'Poor';
        case 5: return 'Very Poor';
        default: return 'Unknown';
    }
}

function initDashboardMap() {
    dashboardMap = L.map('dashboard-map', {
        zoomControl: false,
        scrollWheelZoom: false,
        dragging: false,
        touchZoom: false,
        doubleClickZoom: false
    }).setView([14.5995, 120.9842], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(dashboardMap);

    // Hide loading indicator
    document.getElementById('dashboard-map-loading').style.display = 'none';

    // Make map clickable to go to full map
    dashboardMap.on('click', function() {
        window.location.href = "{% url 'weather_map' %}";
    });
}

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('dashboard-map')) {
        initDashboardMap();
    }

    getUserLocationAndWeather();

    // Auto-refresh every 5 minutes
    setInterval(() => {
        const { lat, lon } = userLocation || DEFAULT_LOCATION;
        fetchWeatherData(lat, lon);
    }, 300000);

    // Alert dismissal handlers
    document.querySelectorAll('[data-dismiss-alert]').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.border-l-4').style.display = 'none';
        });
    });
});
</script>

<!-- User Location Tracker -->
{% load static %}
<script src="{% static 'js/map/user_location.js' %}"></script>
{% endblock %}