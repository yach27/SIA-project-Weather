<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}ClimaChat - Your Weather Assistant{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .weather-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<div class="flex min-h-screen">
    {% include 'user/components/sidebar/user_sidebar.html' %}

    <!-- Main Content -->
    <div id="main-content" class="flex-1">
        <!-- Top Navigation Bar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Mobile menu button -->
                    <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>

                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">{% block page_title %}Dashboard{% endblock %}</h1>
                        <p class="text-sm text-gray-500">{% block page_subtitle %}Welcome back!{% endblock %}</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Weather Quick Info -->
                    <div class="hidden md:flex items-center space-x-2">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        <span id="current-location" class="text-sm font-medium text-gray-700">--</span>
                    </div>

                    <!-- Notifications -->
                    <div class="relative">
                        <button id="notification-bell-btn" class="p-2 rounded-full text-gray-600 hover:text-gray-900 hover:bg-gray-100 relative transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">0</span>
                        </button>

                        {% include 'user/components/notifications/notification_dropdown.html' %}
                    </div>

                    <!-- User Menu -->
                    <div class="relative">
                        <button class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-medium">
                                    {{ user.first_name|first|default:user.username|first|upper }}
                                </span>
                            </div>
                            <span class="hidden md:block text-sm font-medium text-gray-700">
                                {{ user.first_name|default:user.username }}
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="p-6">
            <!-- Weather Alert Dialog (Small, Right Side, Animated Border) -->
            <div id="weather-alert" class="hidden fixed right-6 top-24 z-50 w-80 rounded-xl shadow-2xl overflow-hidden animate-slide-in">
                <style>
                    @keyframes slide-in {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes border-pulse {
                        0%, 100% {
                            opacity: 1;
                        }
                        50% {
                            opacity: 0.5;
                        }
                    }
                    .animate-slide-in {
                        animation: slide-in 0.5s ease-out;
                    }
                    .animate-border {
                        position: relative;
                    }
                    .animate-border::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        bottom: 0;
                        width: 4px;
                        animation: border-pulse 2s ease-in-out infinite;
                    }
                </style>
                <div class="animate-border">
                    <div class="bg-white p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <div id="alert-icon-container" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center">
                                    <svg id="alert-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <h3 id="alert-title" class="font-bold text-sm"></h3>
                            </div>
                            <button onclick="dismissWeatherAlert()" class="flex-shrink-0 text-gray-400 hover:text-gray-600 transition-colors">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <p id="alert-message" class="text-xs text-gray-600 leading-relaxed"></p>
                    </div>
                </div>
            </div>

            {% block content %}
            {% endblock %}
        </main>
    </div>
</div>

<!-- Mobile sidebar backdrop -->
<div id="mobile-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden hidden"></div>

<!-- Notification System -->
{% now "U" as cache_bust %}
<script src="{% static 'js/user/notifications.js' %}?v={{ cache_bust }}"></script>

{% block extra_js %}{% endblock %}

<script>
const OPENWEATHER_API_KEY = "{{ OPENWEATHER_API_KEY }}";
console.log('OPENWEATHER_API_KEY loaded:', OPENWEATHER_API_KEY ? 'Yes (length: ' + OPENWEATHER_API_KEY.length + ')' : 'No');

// Update header location on page load
async function updateHeaderLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}`);
                    const data = await response.json();

                    if (data && data.name) {
                        const location = `${data.name}, ${data.sys.country}`;
                        const locationElement = document.getElementById('current-location');
                        if (locationElement) {
                            locationElement.textContent = location;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching location:', error);
                }
            },
            function(error) {
                // Fallback to Manila
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=14.5995&lon=120.9842&units=metric&appid=${OPENWEATHER_API_KEY}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.name) {
                            const location = `${data.name}, ${data.sys.country}`;
                            const locationElement = document.getElementById('current-location');
                            if (locationElement) {
                                locationElement.textContent = location;
                            }
                        }
                    });
            }
        );
    } else {
        // No geolocation, use fallback
        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=14.5995&lon=120.9842&units=metric&appid=${OPENWEATHER_API_KEY}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.name) {
                    const location = `${data.name}, ${data.sys.country}`;
                    const locationElement = document.getElementById('current-location');
                    if (locationElement) {
                        locationElement.textContent = location;
                    }
                }
            });
    }
}

// Mobile menu functionality
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.querySelector('[data-sidebar]');
    const backdrop = document.getElementById('mobile-backdrop');

    function toggleMobileMenu() {
        sidebar.classList.toggle('-translate-x-full');
        backdrop.classList.toggle('hidden');
    }

    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
    backdrop.addEventListener('click', toggleMobileMenu);

    // Update header location immediately
    updateHeaderLocation();

    // Load weather alert on page load
    loadWeatherAlert();
});

// Dismiss weather alert using Django backend
async function dismissWeatherAlert() {
    const alert = document.getElementById('weather-alert');
    alert.classList.add('hidden');

    // Call Django API to dismiss alert (sets session flag)
    try {
        await fetch('/api/dismiss-alert/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        console.log('Alert dismissed via Django session - will not show again this session');
    } catch (error) {
        console.error('Error dismissing alert:', error);
    }
}

// Load weather alert
async function loadWeatherAlert() {
    // Check if this page has disabled the base weather alert
    if (window.disableBaseWeatherAlert === true) {
        console.log('Base weather alert disabled on this page');
        return;
    }

    // Check if alert was dismissed using Django session
    console.log('[Alert Check] Checking if alert was dismissed...');
    try {
        // Make a simple GET request to check session status
        const checkResponse = await fetch('/api/dismiss-alert/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        console.log('[Alert Check] Response status:', checkResponse.status);

        // If we can't check, continue with showing alert
        if (checkResponse.ok) {
            const data = await checkResponse.json();
            console.log('[Alert Check] Response data:', data);

            if (data.dismissed === true) {
                console.log('[Alert Check] ‚úì Alert was already dismissed - NOT showing');
                return;
            } else {
                console.log('[Alert Check] Alert not yet dismissed - will show');
            }
        }
    } catch (error) {
        console.error('[Alert Check] Error checking alert status:', error);
        // Continue to show alert if check fails
    }

    console.log('[Alert Check] Proceeding to load weather alert...');

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                console.log('Got user location:', lat, lon);
                await fetchWeatherAndShowAlert(lat, lon);
            },
            function(error) {
                console.error('Geolocation error:', error);
                console.log('Using fallback location: Manila, Philippines');
                // Fallback to Manila, Philippines
                fetchWeatherAndShowAlert(14.5995, 120.9842);
            },
            {
                timeout: 10000,
                enableHighAccuracy: false
            }
        );
    } else {
        console.log('Geolocation not supported, using fallback');
        fetchWeatherAndShowAlert(14.5995, 120.9842);
    }
}

// Fetch weather and show alert
async function fetchWeatherAndShowAlert(lat, lon) {
    try {
        console.log('Fetching weather data for alert...');
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${OPENWEATHER_API_KEY}`;
        console.log('API URL:', url.replace(OPENWEATHER_API_KEY, 'API_KEY_HIDDEN'));

        const response = await fetch(url);
        const data = await response.json();

        console.log('Weather data received:', data);

        if (data && data.main) {
            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const location = `${data.name}, ${data.sys.country}`;
            const condition = data.weather[0].main;

            console.log('Weather info:', { temp, feelsLike, location, condition });

            // Update location in navbar
            const locationElement = document.getElementById('current-location');
            if (locationElement) {
                locationElement.textContent = location;
                console.log('Updated navbar location');
            }

            // Show weather alert
            showWeatherAlert(temp, feelsLike, location, condition);
        } else {
            console.error('Invalid weather data structure:', data);
        }
    } catch (error) {
        console.error('Error fetching weather for alert:', error);
    }
}

// Show weather alert based on temperature
function showWeatherAlert(temp, feelsLike, location, condition) {
    console.log('showWeatherAlert called with:', { temp, feelsLike, location, condition });

    const alert = document.getElementById('weather-alert');
    const alertTitle = document.getElementById('alert-title');
    const alertMessage = document.getElementById('alert-message');
    const alertIcon = document.getElementById('alert-icon');

    console.log('Alert elements found:', {
        alert: !!alert,
        alertTitle: !!alertTitle,
        alertMessage: !!alertMessage,
        alertIcon: !!alertIcon
    });

    if (!alert || !alertTitle || !alertMessage || !alertIcon) {
        console.error('Weather alert elements not found in DOM');
        return;
    }

    let title, message, bgColor, textColor, borderColor, iconSVG;

    if (temp >= 35) {
        // Extreme Hot
        title = `üî• Extreme Heat Alert in ${location}`;
        message = `Current temperature is ${temp}¬∞C (feels like ${feelsLike}¬∞C). Stay indoors, drink plenty of water, and avoid strenuous activities.`;
        bgColor = 'bg-red-50';
        textColor = 'text-red-800';
        borderColor = 'border-red-500';
        iconSVG = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>`;
    } else if (temp >= 30) {
        // Hot
        title = `üå°Ô∏è Hot Weather in ${location}`;
        message = `Temperature is ${temp}¬∞C (feels like ${feelsLike}¬∞C). Stay hydrated and use sun protection when outdoors.`;
        bgColor = 'bg-orange-50';
        textColor = 'text-orange-800';
        borderColor = 'border-orange-500';
        iconSVG = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>`;
    } else if (temp <= 10) {
        // Cold
        title = `‚ùÑÔ∏è Cold Weather in ${location}`;
        message = `Temperature is ${temp}¬∞C (feels like ${feelsLike}¬∞C). Dress warmly in layers and protect yourself from the cold.`;
        bgColor = 'bg-blue-50';
        textColor = 'text-blue-800';
        borderColor = 'border-blue-500';
        iconSVG = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>`;
    } else if (temp <= 18) {
        // Cool
        title = `üçÉ Cool Weather in ${location}`;
        message = `Temperature is ${temp}¬∞C (feels like ${feelsLike}¬∞C). Consider wearing a light jacket when going outside.`;
        bgColor = 'bg-cyan-50';
        textColor = 'text-cyan-800';
        borderColor = 'border-cyan-500';
        iconSVG = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>`;
    } else {
        // Normal/Pleasant
        title = `‚ú® Pleasant Weather in ${location}`;
        message = `Temperature is ${temp}¬∞C (feels like ${feelsLike}¬∞C). Perfect conditions for outdoor activities!`;
        bgColor = 'bg-green-50';
        textColor = 'text-green-800';
        borderColor = 'border-green-500';
        iconSVG = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>`;
    }

    // Special conditions
    if (condition === 'Rain' || condition === 'Thunderstorm') {
        title = `üåßÔ∏è ${condition} Alert in ${location}`;
        message = `${condition} detected with temperature ${temp}¬∞C. Carry an umbrella and drive carefully.`;
        bgColor = 'bg-indigo-50';
        textColor = 'text-indigo-800';
        borderColor = 'border-indigo-500';
    } else if (condition === 'Snow') {
        title = `üå®Ô∏è Snow Alert in ${location}`;
        message = `Snow detected with temperature ${temp}¬∞C. Exercise caution when traveling and dress warmly.`;
        bgColor = 'bg-blue-50';
        textColor = 'text-blue-800';
        borderColor = 'border-blue-500';
    }

    // Update alert content
    console.log('Setting alert content:', { title, message, bgColor, textColor, borderColor });
    alertTitle.textContent = title;
    alertMessage.textContent = message;
    alertIcon.innerHTML = iconSVG;

    // Update icon container background
    const iconContainer = document.getElementById('alert-icon-container');
    if (iconContainer) {
        iconContainer.className = `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${bgColor}`;
    }

    // Update title color
    alertTitle.className = `font-bold text-sm ${textColor}`;

    // Update animated border color
    const animatedBorder = alert.querySelector('.animate-border');
    if (animatedBorder && animatedBorder.querySelector('::before')) {
        // Set the border color via inline style
        const borderColorHex = borderColor.replace('border-', '');
        animatedBorder.style.setProperty('--border-color', borderColorHex);
    }

    // Set animated border color using CSS variable
    const style = document.createElement('style');
    style.textContent = `
        #weather-alert .animate-border::before {
            background-color: ${borderColor.replace('border-', '')
                .replace('red-500', '#ef4444')
                .replace('orange-500', '#f97316')
                .replace('blue-500', '#3b82f6')
                .replace('cyan-500', '#06b6d4')
                .replace('green-500', '#22c55e')
                .replace('indigo-500', '#6366f1')
            };
        }
    `;
    document.head.appendChild(style);

    // Show alert with animation
    console.log('Removing hidden class from alert');
    alert.classList.remove('hidden');
    console.log('Alert should now be visible');
}
</script>
</body>
</html>