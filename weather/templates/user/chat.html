{% extends "user/layouts/base.html" %}

{% block title %}Weather Chat - ClimaChat{% endblock %}
{% block page_title %}Weather Chat{% endblock %}
{% block page_subtitle %}Ask me anything about weather conditions{% endblock %}

{% block extra_head %}
<!-- Leaflet CSS and JS for the mini weather map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* Custom scrollbar styling */
    .scrollbar-thin {
        scrollbar-width: thin;
    }
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Chat container improvements */
    #chat-messages {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 h-[calc(100vh-200px)] flex flex-col max-w-none">
        <!-- Chat Header -->
        <div class="border-b border-gray-200 p-6 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900">ClimaChat Assistant</h3>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                    Powered by AI
                </span>
            </div>
        </div>

        <!-- Chat Messages Area with Weather Map -->
        <div class="flex-1 flex min-h-0">
            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="chat-messages">
                <div class="text-center text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p>Start a conversation</p>
                    <p class="text-xs">Ask about weather conditions, forecasts, or safety tips</p>
                </div>
            </div>

            <!-- Weather Map Panel -->
            <div class="w-80 border-l border-gray-200 bg-gray-50 flex flex-col" id="weather-map-panel">
                <div class="p-4 border-b border-gray-200 flex-shrink-0">
                    <h3 class="font-semibold text-gray-900">Weather Data</h3>
                    <p class="text-xs text-gray-500">Real-time weather information</p>
                </div>
                <div class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 p-4">
                    <!-- Weather Map -->
                    <div id="chat-weather-map" class="h-48 bg-gray-200 rounded-lg mb-4 flex-shrink-0"></div>

                    <!-- Weather Data Display -->
                    <div id="weather-data-display" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            <svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.4 4.4 0 003 15z"></path>
                            </svg>
                            <p class="text-sm">Ask about a location to see weather data</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="border-t border-gray-200 p-6">
            <div class="flex space-x-4">
                <input
                    type="text"
                    placeholder="Ask about weather... (e.g., 'What's the weather like today?')"
                    class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    id="chat-input"
                >
                <button
                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2"
                    id="send-btn"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <span>Send</span>
                </button>
            </div>

            <!-- Quick Suggestions -->
            <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">Quick questions:</p>
                <div class="flex flex-wrap gap-2">
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full transition-colors"
                            data-question="What's the weather like today?">
                        Today's weather
                    </button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full transition-colors"
                            data-question="Will it rain tomorrow?">
                        Will it rain tomorrow?
                    </button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full transition-colors"
                            data-question="What should I wear today?">
                        What to wear?
                    </button>
                    <button class="quick-question bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm px-3 py-1 rounded-full transition-colors"
                            data-question="Are there any weather alerts?">
                        Weather alerts
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// User Chat functionality with weather map integration
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');
    const quickQuestions = document.querySelectorAll('.quick-question');
    const weatherMapPanel = document.getElementById('weather-map-panel');
    const weatherDataDisplay = document.getElementById('weather-data-display');

    let conversationHistory = [];
    let isLoading = false;
    let weatherMap = null;
    const OPENWEATHER_API_KEY = "c58e8978703203f1a7ad55379a588e2c";

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Initialize weather map
    function initWeatherMap() {
        if (weatherMap) {
            weatherMap.remove();
        }

        weatherMap = L.map('chat-weather-map').setView([14.5995, 120.9842], 6); // Philippines center

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(weatherMap);

        return weatherMap;
    }

    // Display weather data in the panel
    function displayWeatherData(weatherData) {
        console.log('Displaying weather data on map:', weatherData);
        weatherMapPanel.classList.remove('hidden');

        const weatherHtml = `
            <div class="bg-white rounded-lg p-3 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-900">${weatherData.location}</h4>
                    <span class="text-2xl">${getWeatherIcon(weatherData.condition_main)}</span>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Temperature:</span>
                        <span class="font-medium">${weatherData.temperature}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Feels like:</span>
                        <span>${weatherData.feels_like}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Condition:</span>
                        <span>${weatherData.condition}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Humidity:</span>
                        <span>${weatherData.humidity}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Wind:</span>
                        <span>${weatherData.wind_speed}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Pressure:</span>
                        <span>${weatherData.pressure}</span>
                    </div>
                </div>
            </div>
        `;

        weatherDataDisplay.innerHTML = weatherHtml;

        // Update map if coordinates are available
        if (weatherData.coordinates) {
            if (!weatherMap) {
                initWeatherMap();
            }

            const lat = weatherData.coordinates.lat;
            const lon = weatherData.coordinates.lon;

            weatherMap.setView([lat, lon], 10);

            // Clear existing markers and weather overlays
            weatherMap.eachLayer(function(layer) {
                if (layer instanceof L.Marker || layer.options.opacity === 0.6) {
                    weatherMap.removeLayer(layer);
                }
            });

            // Add marker for the location
            const marker = L.marker([lat, lon]).addTo(weatherMap);
            marker.bindPopup(`
                <strong>${weatherData.location}</strong><br>
                ${weatherData.condition}<br>
                ${weatherData.temperature}
            `).openPopup();

            // Add weather overlay
            L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${OPENWEATHER_API_KEY}`, {
                opacity: 0.6
            }).addTo(weatherMap);
        }
    }

    // Get weather icon emoji
    function getWeatherIcon(condition) {
        const icons = {
            'Clear': 'âï¸',
            'Clouds': 'âï¸',
            'Rain': 'ð§ï¸',
            'Drizzle': 'ð¦ï¸',
            'Thunderstorm': 'âï¸',
            'Snow': 'âï¸',
            'Mist': 'ð«ï¸',
            'Fog': 'ð«ï¸',
            'Haze': 'ð«ï¸'
        };
        return icons[condition] || 'ð¤ï¸';
    }

    function addMessage(content, isUser = true, isLoading = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

        const time = getCurrentTime();
        let messageContent = '';

        if (isLoading) {
            messageContent = `
                <div class="max-w-xs lg:max-w-md bg-gray-100 text-gray-900 rounded-lg px-4 py-3">
                    <div class="flex items-center space-x-2">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        </div>
                        <span class="text-xs text-gray-500 ml-2">ClimaChat is thinking...</span>
                    </div>
                </div>
            `;
        } else {
            messageContent = `
                <div class="max-w-sm lg:max-w-lg xl:max-w-xl ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-900'} rounded-lg px-4 py-3 break-words">
                    ${!isUser ? '<p class="text-xs text-gray-500 mb-1">ClimaChat</p>' : ''}
                    <p class="text-sm whitespace-pre-wrap leading-relaxed">${content}</p>
                    <p class="text-xs ${isUser ? 'text-blue-100' : 'text-gray-500'} mt-1">${time}</p>
                </div>
            `;
        }

        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
    }

    function removeMessage(messageElement) {
        if (messageElement && messageElement.parentNode) {
            messageElement.parentNode.removeChild(messageElement);
        }
    }

    async function sendMessageToAPI(message) {
        try {
            const response = await fetch('/api/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_history: conversationHistory
                })
            });

            const data = await response.json();

            if (data.success) {
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.response }
                );

                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

                return {
                    success: true,
                    response: data.response,
                    fallback: data.fallback || false,
                    weather_data: data.weather_data || false,
                    weather_info: data.weather_info || null
                };
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('Chatbot API error:', error);
            return {
                success: false,
                response: "I'm experiencing some technical difficulties right now. Please try again in a moment!"
            };
        }
    }

    async function sendMessage(message = null) {
        if (isLoading) return;

        const messageText = message || chatInput.value.trim();
        if (!messageText) return;

        isLoading = true;
        chatInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';

        addMessage(messageText, true);
        if (!message) chatInput.value = '';

        const loadingMessage = addMessage('', false, true);

        try {
            const result = await sendMessageToAPI(messageText);
            removeMessage(loadingMessage);
            addMessage(result.response, false);

            // If weather data is available, display it in the map panel
            if (result.weather_data && result.weather_info) {
                console.log('Weather data received:', result.weather_info);
                displayWeatherData(result.weather_info);
            } else {
                console.log('No weather data to display. weather_data:', result.weather_data, 'weather_info:', result.weather_info);
            }

            if (result.fallback) {
                console.warn('Using fallback response due to API issues');
            }
        } catch (error) {
            removeMessage(loadingMessage);
            addMessage("I'm sorry, I'm having trouble right now. Please try again later!", false);
        } finally {
            isLoading = false;
            chatInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                <span>Send</span>
            `;
            chatInput.focus();
        }
    }

    function clearDefaultContent() {
        const defaultContent = chatMessages.querySelector('.text-center');
        if (defaultContent) {
            chatMessages.innerHTML = '';
        }
    }

    // Event listeners
    sendBtn.addEventListener('click', function() {
        clearDefaultContent();
        sendMessage();
    });

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            clearDefaultContent();
            sendMessage();
        }
    });

    // Quick question buttons
    quickQuestions.forEach(button => {
        button.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            clearDefaultContent();
            sendMessage(question);
        });
    });

    // Initialize weather map on page load
    setTimeout(() => {
        initWeatherMap();
    }, 100);

    // Welcome message
    setTimeout(() => {
        clearDefaultContent();
        addMessage("Hello! I'm ClimaChat, your personal weather assistant. I can help you with current weather, forecasts, safety tips, and more. What would you like to know?", false);
    }, 500);
});
</script>
{% endblock %}