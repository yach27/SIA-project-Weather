{% extends "admin/layouts/base.html" %}

{% block title %}Weather Chatbot - ClimaChat Admin{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
// Make OpenWeather API key available to JavaScript
const OPENWEATHER_API_KEY = "{{ OPENWEATHER_API_KEY }}";
console.log('Admin chat - OPENWEATHER_API_KEY loaded:', OPENWEATHER_API_KEY ? 'Yes' : 'No');
</script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Weather Chatbot</h1>
    <p class="text-gray-600 mt-2">Test and monitor the weather chatbot responses</p>
</div>

<div class="max-w-6xl mx-auto relative">
    {% include 'admin/components/chat/chat_interface.html' %}
    {% include 'admin/components/chat/user_map_widget.html' %}
    {% include 'admin/components/chat/chat_history_sidebar.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables and functions accessible to all scripts
let conversationHistory = [];
let lastMentionedUser = null;
let currentSessionId = null;  // Track current conversation session

// Generate unique session ID
function generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
}

function addMessage(content, isUser = true, isLoading = false) {
    const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

        const time = getCurrentTime();
        let messageContent = '';

        if (isLoading) {
            messageContent = `
                <div class="max-w-xs lg:max-w-md bg-gray-100 text-gray-900 rounded-lg px-3 py-2">
                    <p class="text-xs text-gray-500 mb-1">Weather Bot</p>
                    <div class="flex items-center space-x-1">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        </div>
                        <span class="text-xs text-gray-500 ml-2">Thinking...</span>
                    </div>
                </div>
            `;
        } else {
            messageContent = `
                <div class="max-w-xs lg:max-w-md ${isUser ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-900'} rounded-lg px-3 py-2">
                    ${!isUser ? '<p class="text-xs text-gray-500 mb-1">Weather Bot</p>' : ''}
                    <p class="text-sm whitespace-pre-wrap">${content}</p>
                    <p class="text-xs ${isUser ? 'text-blue-100' : 'text-gray-500'} mt-1">${time}</p>
                </div>
            `;
        }

        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return messageDiv;
}

function removeMessage(messageElement) {
    if (messageElement && messageElement.parentNode) {
        messageElement.parentNode.removeChild(messageElement);
    }
}

// Real-time weather chatbot using Groq API
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatMessages = document.getElementById('chat-messages');

    let isLoading = false;

    async function sendMessageToAPI(message) {
        try {
            // Fetch user locations for admin context
            let userLocationsData = [];
            let weatherDataForUser = null;

            try {
                const locResponse = await fetch('/api/admin/user-locations/');
                const locData = await locResponse.json();
                if (locData.success) {
                    userLocationsData = locData.locations;

                    // Check if message mentions a user and weather-related keywords
                    const weatherKeywords = ['weather', 'temperature', 'temp', 'rain', 'sunny', 'cloud', 'condition', 'hot', 'cold', 'humid'];
                    const hasWeatherWord = weatherKeywords.some(word => message.toLowerCase().includes(word));

                    // Check for follow-up affirmations
                    const affirmations = ['yes', 'yeah', 'yep', 'sure', 'ok', 'okay', 'yup'];
                    const isAffirmation = affirmations.some(word => message.toLowerCase().trim() === word);

                    let targetUser = null;

                    // If affirmation and we have a last mentioned user, use that user
                    if (isAffirmation && lastMentionedUser) {
                        targetUser = userLocationsData.find(loc => loc.username === lastMentionedUser);
                        console.log('Follow-up detected for:', lastMentionedUser);
                    } else if (hasWeatherWord || message.toLowerCase().includes('where')) {
                        // Find which user is mentioned
                        for (const loc of userLocationsData) {
                            if (message.toLowerCase().includes(loc.username.toLowerCase())) {
                                targetUser = loc;
                                lastMentionedUser = loc.username;
                                break;
                            }
                        }
                    } else {
                        // Check if any username is mentioned for future follow-up
                        for (const loc of userLocationsData) {
                            if (message.toLowerCase().includes(loc.username.toLowerCase())) {
                                lastMentionedUser = loc.username;
                                break;
                            }
                        }
                    }

                    // Fetch weather if we have a target user
                    if (targetUser) {
                        console.log('Fetching weather for:', targetUser.username);

                        // Zoom map to user's location
                        if (window.zoomToUser) {
                            window.zoomToUser(targetUser.username);
                        }

                        // Fetch weather
                        try {
                            const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${targetUser.latitude}&lon=${targetUser.longitude}&appid=${OPENWEATHER_API_KEY}&units=metric`);
                            const weatherData = await weatherResponse.json();

                            if (weatherResponse.ok) {
                                weatherDataForUser = {
                                    username: targetUser.username,
                                    location: targetUser.location_name || 'Unknown',
                                    temperature: weatherData.main.temp,
                                    feels_like: weatherData.main.feels_like,
                                    condition: weatherData.weather[0].description,
                                    humidity: weatherData.main.humidity,
                                    wind_speed: weatherData.wind.speed,
                                    pressure: weatherData.main.pressure
                                };
                                console.log('Weather data prepared:', weatherDataForUser);
                            }
                        } catch (err) {
                            console.error('Error fetching weather:', err);
                        }
                    }
                }
            } catch (e) {
                console.log('Could not fetch user locations:', e);
            }

            // Generate session ID if starting new conversation
            if (!currentSessionId) {
                currentSessionId = generateSessionId();
                console.log('ðŸ†• Started new session:', currentSessionId);
            }

            const requestData = {
                message: message,
                conversation_history: conversationHistory,
                user_locations: userLocationsData,
                user_weather_data: weatherDataForUser,
                is_admin: true,
                save_to_history: true,
                session_id: currentSessionId  // Include session ID to group messages
            };

            console.log('ðŸ“¤ Sending to chatbot API:', requestData);

            const response = await fetch('/api/chatbot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            console.log('Chatbot API Response:', data);

            if (data.success) {
                // Add to conversation history
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.response }
                );

                // Keep only last 10 exchanges (20 messages) for context
                if (conversationHistory.length > 20) {
                    conversationHistory = conversationHistory.slice(-20);
                }

                return {
                    success: true,
                    response: data.response,
                    fallback: data.fallback || false
                };
            } else {
                console.error('API returned error:', data.error);
                throw new Error(data.error || 'Unknown error');
            }
        } catch (error) {
            console.error('Chatbot API error:', error);
            return {
                success: false,
                response: "I'm experiencing some technical difficulties right now. Please try again in a moment, or ask me about weather information!"
            };
        }
    }

    async function sendMessage() {
        if (isLoading) return;

        const message = chatInput.value.trim();
        if (!message) return;

        // Disable input while processing
        isLoading = true;
        chatInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';

        // Add user message
        addMessage(message, true);
        chatInput.value = '';

        // Add loading indicator
        const loadingMessage = addMessage('', false, true);

        try {
            // Send to API
            const result = await sendMessageToAPI(message);

            // Remove loading indicator
            removeMessage(loadingMessage);

            // Add bot response
            addMessage(result.response, false);

            if (result.fallback) {
                console.warn('Using fallback response due to API issues');
            }

        } catch (error) {
            // Remove loading indicator
            removeMessage(loadingMessage);

            // Add error message
            addMessage("I'm sorry, I'm having trouble right now. Please try again later!", false);
        } finally {
            // Re-enable input
            isLoading = false;
            chatInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            `;
            chatInput.focus();
        }
    }

    // Clear default "no messages" content on first message
    function clearDefaultContent() {
        const defaultContent = chatMessages.querySelector('.text-center');
        if (defaultContent) {
            chatMessages.innerHTML = '';
        }
    }

    // Event listeners
    sendBtn.addEventListener('click', function() {
        clearDefaultContent();
        sendMessage();
    });

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            clearDefaultContent();
            sendMessage();
        }
    });

    // Add welcome message on load
    setTimeout(() => {
        clearDefaultContent();
        addMessage("Hello! I'm ClimaChat, your AI weather assistant powered by Llama 3.3. I'm here to help you with weather information, forecasts, and weather-related questions. How can I assist you today?", false);
    }, 500);
});
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// User Location Map Widget
document.addEventListener('DOMContentLoaded', function() {
    let userMap = null;
    let userMarkers = [];

    // Initialize map
    function initMap() {
        userMap = L.map('admin-chat-user-map', {
            zoomControl: true,
            attributionControl: false
        }).setView([14.5995, 120.9842], 6); // Philippines center

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(userMap);

        console.log('Chat user map initialized');
        loadUserLocations();
    }

    // Load user locations from API
    async function loadUserLocations() {
        const loadingEl = document.getElementById('chat-map-loading');
        if (loadingEl) loadingEl.classList.remove('hidden');

        try {
            const response = await fetch('/api/admin/user-locations/');
            const data = await response.json();

            if (data.success) {
                clearMarkers();
                displayUsers(data.locations);
                updateUserCount(data.locations.length);
                displayUserList(data.locations);
            }
        } catch (error) {
            console.error('Failed to load user locations:', error);
        } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

    // Clear existing markers
    function clearMarkers() {
        userMarkers.forEach(marker => userMap.removeLayer(marker));
        userMarkers = [];
    }

    // Display users on map
    function displayUsers(locations) {
        if (!locations.length) return;

        const bounds = [];

        locations.forEach(user => {
            const icon = L.divIcon({
                className: 'user-marker-icon',
                html: `<div style="
                    background: #10b981;
                    width: 22px;
                    height: 22px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 11px;
                    cursor: pointer;
                ">
                    ${user.username.charAt(0).toUpperCase()}
                </div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });

            const marker = L.marker([user.latitude, user.longitude], { icon })
                .bindPopup(`
                    <div style="padding: 8px; min-width: 160px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 14px; font-weight: 600;">
                            ${user.username}
                        </h4>
                        <p style="margin: 0; font-size: 12px; color: #6b7280;">
                            ${user.email}
                        </p>
                        <p style="margin: 6px 0 0 0; font-size: 11px; color: #d1d5db;">
                            Last seen: ${new Date(user.updated_at).toLocaleString()}
                        </p>
                    </div>
                `)
                .addTo(userMap);

            userMarkers.push(marker);
            bounds.push([user.latitude, user.longitude]);
        });

        // Fit map to show all markers
        if (bounds.length > 0) {
            userMap.fitBounds(bounds, { padding: [30, 30] });
        }
    }

    // Update user count
    function updateUserCount(count) {
        const countEl = document.getElementById('active-users-count');
        if (countEl) {
            countEl.textContent = count;
        }
    }

    // Display user list
    function displayUserList(locations) {
        const userListEl = document.getElementById('user-list');
        if (!userListEl) return;

        if (!locations.length) {
            userListEl.innerHTML = '<p class="text-xs text-gray-500 text-center">No users online</p>';
            return;
        }

        userListEl.innerHTML = locations.map(user => `
            <div class="flex items-center justify-between p-1.5 bg-white rounded hover:bg-gray-50 transition-colors">
                <div class="flex items-center space-x-2">
                    <div class="w-5 h-5 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-xs font-medium">${user.username.charAt(0).toUpperCase()}</span>
                    </div>
                    <span class="text-xs font-medium text-gray-900">${user.username}</span>
                </div>
                <span class="text-xs text-gray-400">${new Date(user.updated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
        `).join('');
    }

    // Refresh button
    const refreshBtn = document.getElementById('refresh-user-map');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            loadUserLocations();
        });
    }

    // Toggle button
    const toggleBtn = document.getElementById('toggle-chat-map');
    const mapContent = document.getElementById('chat-map-content');
    let isCollapsed = false;

    if (toggleBtn && mapContent) {
        toggleBtn.addEventListener('click', () => {
            isCollapsed = !isCollapsed;

            if (isCollapsed) {
                mapContent.style.display = 'none';
                toggleBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>';
            } else {
                mapContent.style.display = 'block';
                toggleBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                setTimeout(() => userMap.invalidateSize(), 300);
            }
        });
    }

    // Function to zoom to a specific user's location
    window.zoomToUser = function(username) {
        const marker = userMarkers.find(m => {
            const popupContent = m.getPopup().getContent();
            return popupContent.includes(username);
        });

        if (marker) {
            const latlng = marker.getLatLng();
            userMap.setView(latlng, 14, { animate: true }); // Zoom level 14 for detailed view
            marker.openPopup();
            console.log('ðŸ—ºï¸ Map zoomed to user:', username, 'at', latlng);
        } else {
            console.log('âš ï¸ User marker not found on map:', username);
        }
    };

    // Initialize map
    initMap();

    // Auto-refresh every 30 seconds
    setInterval(loadUserLocations, 30000);
});

// Chat History Sidebar
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('chat-history-sidebar');
    const toggleBtn = document.getElementById('toggle-history-btn');
    const closeBtn = document.getElementById('close-history-sidebar');
    const historyItems = document.getElementById('history-items');
    const historyLoading = document.getElementById('history-loading');
    const historyEmpty = document.getElementById('history-empty');

    // Toggle sidebar
    toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('translate-x-full');
        if (!sidebar.classList.contains('translate-x-full')) {
            loadChatHistory();
        }
    });

    closeBtn.addEventListener('click', function() {
        sidebar.classList.add('translate-x-full');
    });

    // Load chat history
    async function loadChatHistory() {
        historyLoading.classList.remove('hidden');
        historyItems.classList.add('hidden');
        historyEmpty.classList.add('hidden');

        try {
            const response = await fetch('/api/admin/chat-history/?limit=50');
            const data = await response.json();

            historyLoading.classList.add('hidden');

            if (data.success && data.conversations.length > 0) {
                historyItems.classList.remove('hidden');
                displayHistory(data.conversations);
            } else {
                historyEmpty.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Failed to load chat history:', error);
            historyLoading.classList.add('hidden');
            historyEmpty.classList.remove('hidden');
        }
    }

    // Store conversations for reference
    let conversationsList = [];

    // Display history
    function displayHistory(conversations) {
        conversationsList = conversations; // Store for later access

        historyItems.innerHTML = conversations.map((session, index) => {
            const date = new Date(session.timestamp);
            const timeStr = date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const messageCount = session.message_count || 1;
            const firstMsg = session.first_message || session.messages[0].message;

            return `
                <div class="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors border border-gray-200 relative group"
                     data-conv-index="${index}">
                    <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 hover:bg-red-600 text-white rounded p-1 z-10"
                            data-delete-session="${session.session_id}"
                            data-delete-index="${index}"
                            title="Delete conversation">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <div class="cursor-pointer" data-load-index="${index}">
                        <div class="flex items-start justify-between mb-2">
                            <p class="text-xs font-medium text-blue-600">${timeStr}</p>
                            <div class="flex items-center gap-2">
                                ${session.user_mentioned ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">${session.user_mentioned}</span>` : ''}
                                ${messageCount > 1 ? `<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${messageCount} msgs</span>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-gray-800 font-medium mb-1 line-clamp-2">${firstMsg}</p>
                        <p class="text-xs text-gray-600 line-clamp-2">${session.messages[0].response.substring(0, 100)}...</p>
                    </div>
                </div>
            `;
        }).join('');

        // Add click handlers for loading conversations
        historyItems.querySelectorAll('[data-load-index]').forEach(item => {
            item.addEventListener('click', function() {
                const index = parseInt(this.dataset.loadIndex);
                const session = conversationsList[index];
                loadConversation(session);
            });
        });

        // Add click handlers for delete buttons
        historyItems.querySelectorAll('[data-delete-session]').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation(); // Prevent loading conversation when clicking delete

                const sessionId = this.dataset.deleteSession;
                const index = parseInt(this.dataset.deleteIndex);

                if (!confirm('Are you sure you want to delete this conversation?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/chat-history/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ session_id: sessionId })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Remove from UI
                        conversationsList.splice(index, 1);
                        displayHistory(conversationsList);
                        console.log('âœ… Conversation deleted');
                    } else {
                        alert('Failed to delete conversation: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete conversation');
                }
            });
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load a specific conversation session
    function loadConversation(session) {
        // Clear current chat
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';

        // Reset conversation history
        conversationHistory = [];

        // Load all messages in this session
        session.messages.forEach(msg => {
            addMessage(msg.message, true);
            addMessage(msg.response, false);

            // Add to conversation history for context
            conversationHistory.push(
                { role: 'user', content: msg.message },
                { role: 'assistant', content: msg.response }
            );

            // Restore last mentioned user from last message
            if (msg.user_mentioned) {
                lastMentionedUser = msg.user_mentioned;
            }
        });

        // Restore session ID - continue in same conversation thread
        currentSessionId = session.session_id;
        console.log(`ðŸ“‚ Loaded session with ${session.messages.length} message(s):`, currentSessionId);

        if (lastMentionedUser) {
            console.log('Restored context: last mentioned user =', lastMentionedUser);
        }

        // Close sidebar
        sidebar.classList.add('translate-x-full');

        console.log('Conversation loaded. You can continue chatting from here.');
    }

    // New Chat Button
    const newChatBtn = document.getElementById('new-chat-btn');
    if (newChatBtn) {
        newChatBtn.addEventListener('click', function() {
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';

                // Add welcome message
                setTimeout(() => {
                    addMessage("Hello! I'm ClimaChat, your AI weather assistant. I can help you check weather for any user location. How can I assist you today?", false);
                }, 300);
            }

            // Clear conversation history
            if (typeof conversationHistory !== 'undefined') {
                conversationHistory = [];
            }

            // Reset last mentioned user
            if (typeof lastMentionedUser !== 'undefined') {
                lastMentionedUser = null;
            }

            // Reset session ID - start fresh conversation thread
            currentSessionId = null;

            // Show notification
            console.log('Started new chat - session will be created on first message');
        });
    }
});
</script>
{% endblock %}